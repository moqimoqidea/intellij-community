---
name: Agent Threads Visibility and More Row
description: Deterministic rendering and persisted visibility rules for thread rows and More-row behavior in Agent Threads.
targets:
  - ../sessions/src/AgentSessionModels.kt
  - ../sessions/src/SessionTree.kt
  - ../sessions/src/SessionTreeRows.kt
  - ../sessions/src/SessionTreeState.kt
  - ../sessions/resources/messages/AgentSessionsBundle.properties
  - ../sessions/testSrc/AgentSessionsToolWindowTest.kt
  - ../sessions/testSrc/AgentSessionsServiceRefreshIntegrationTest.kt
  - ../sessions/testSrc/AgentSessionsServiceOnDemandIntegrationTest.kt
---

# Agent Threads Visibility and More Row

Status: Draft
Date: 2026-02-22

## Summary
Define deterministic visibility rules for project/worktree thread rows so empty state, warning/error rows, and `More` rows never conflict. Shared visibility primitive semantics are canonical in `spec/agent-core-contracts.spec.md`; this spec owns rendering and precedence behavior.

## Goals
- Keep row visibility deterministic after refresh and on-demand loads.
- Support exact-count and unknown-count hidden-thread states.
- Prevent contradictory rows for the same node.

## Non-goals
- Provider-side pagination strategy.
- Aggregation/source-loading behavior.
- Command mapping or editor-tab contracts.

## Requirements
- Initial visible-thread count per normalized path must be `DEFAULT_VISIBLE_THREAD_COUNT` (`3`).
  [@test] ../sessions/testSrc/AgentSessionsToolWindowTest.kt

- Visible-thread count lookup order per normalized path must be:
  - in-memory runtime entry,
  - persisted tree UI state entry,
  - default value.
  [@test] ../sessions/testSrc/AgentSessionsServiceRefreshIntegrationTest.kt
  [@test] ../sessions/testSrc/AgentSessionsTreeUiStateServiceTest.kt

- For project rows, render `More` only when `project.threads.size > visibleCount`.
  [@test] ../sessions/testSrc/AgentSessionsToolWindowTest.kt

- For worktree rows, render `More` only when `worktree.threads.size > visibleCount`.
  [@test] ../sessions/testSrc/AgentSessionsToolWindowTest.kt

- When `hasUnknownThreadCount=true` for the node, `More` must render without explicit count (`toolwindow.action.more`).
  [@test] ../sessions/testSrc/AgentSessionsToolWindowTest.kt

- When `hasUnknownThreadCount=false`, `More` must render with explicit hidden count (`toolwindow.action.more.count`) using `threads.size - visibleCount`.
  [@test] ../sessions/testSrc/AgentSessionsToolWindowTest.kt

- `No recent activity yet.` must render only when:
  - `hasLoaded=true`,
  - no visible project threads,
  - no visible worktree rows with content/loading/error/warnings,
  - no project-level error,
  - no provider warnings.
  [@test] ../sessions/testSrc/AgentSessionsToolWindowTest.kt

- Project/worktree error rows must take precedence over warning and empty rows.
  [@test] ../sessions/testSrc/AgentSessionsToolWindowTest.kt

- `showMoreThreads(path)` and `ensureThreadVisible(path, provider, threadId)` must follow increment/persistence contract defined in `spec/agent-core-contracts.spec.md`.
  [@test] ../sessions/testSrc/AgentSessionsServiceOnDemandIntegrationTest.kt
  [@test] ../sessions/testSrc/AgentSessionsToolWindowTest.kt

- Refresh bootstrap must restore persisted visible-thread counts above default for known project/worktree paths.
  [@test] ../sessions/testSrc/AgentSessionsServiceRefreshIntegrationTest.kt

- Persisted visibility key normalization must follow `spec/agent-core-contracts.spec.md`.
  [@test] ../sessions/testSrc/AgentSessionsTreeUiStateServiceTest.kt

- Tree-side `More` click handling must not trigger backend loads directly; it only updates local visibility state.
  [@test] ../sessions/testSrc/AgentSessionsServiceOnDemandIntegrationTest.kt

## User Experience
- Exact-count case renders `More (N)`.
- Unknown-count case renders `Moreâ€¦`.
- Empty helper row is mutually exclusive with `More`, warning, and error rows for the same node.
- Non-default visibility persists across refresh and reopen for the same normalized path.

## Data & Backend
- Unknown-count state is produced by service aggregation layer (`hasUnknownThreadCount`), not tree rendering.
- Tree rendering consumes pre-sorted thread lists and performs no additional ordering.

## Error Handling
- Visibility updates must remain safe when underlying state changes between interactions.
- Error/warning display must follow precedence rules without conflicting helper rows.

## Testing / Local Run
- `./tests.cmd '-Dintellij.build.test.patterns=com.intellij.agent.workbench.sessions.AgentSessionsToolWindowTest'`
- `./tests.cmd '-Dintellij.build.test.patterns=com.intellij.agent.workbench.sessions.AgentSessionsServiceRefreshIntegrationTest'`
- `./tests.cmd '-Dintellij.build.test.patterns=com.intellij.agent.workbench.sessions.AgentSessionsServiceOnDemandIntegrationTest'`

## Open Questions / Risks
- If providers begin exposing exact remote totals independent of loaded rows, count semantics may require richer model than current hidden-row math.

## References
- `spec/agent-core-contracts.spec.md`
- `spec/agent-sessions.spec.md`
